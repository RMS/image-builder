machine:
  environment:
    IMAGE_REPO: "circleci/build-image"
    BUILD_TARGET: "ubuntu-14.04-thin"

  pre:
    - echo 'no_cache() { git log --format=%B -n 1 | grep -q "no cache"; }' >> ~/.circlerc
    - git clone git@github.com:kimh/docker-cache-shim.git && cd docker-cache-shim && sudo ./install.sh

  post:
    - sudo curl -L -o /usr/bin/docker 'https://s3.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo service docker start
    - sudo docker login --username="$BUILDUSER" --password="$BUILDPASS" --email="$BUILDEMAIL" eastus-artifactory.azure.rmsonecloud.net:6001

dependencies:
  override:
    - sudo docker login -e $BUILDEMAIL -u $BUILDUSER -p $BUILDPASS

    - ? |
        if [ "$CIRCLE_BRANCH" == "ci-azure" ]; then
          echo "In 'ci-azure' branch, building production 'buildbox' image with tag 'latest'"
          export TAG=latest
        else
          echo "Building a test image with tag $CIRCLE_BRANCH"
          export TAG=$CIRCLE_BRANCH
        fi

       # builds and pushes
        ./build.sh
      :
        timeout: 7200

test:
  override:
    - echo "skip tests.."

deployment:
  production:
    branch: master
    commands:
      - for TARGET in $(echo $BUILD_TARGET); do make deploy-${TARGET}; done:
          timeout: 3600
